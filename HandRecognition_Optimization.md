# 手部識別優化建議

## 當前優化措施

### 1. 降低置信度閾值
- 從 0.7 降低到 0.5，提高檢測靈敏度
- 可以在測試視圖中觀察置信度數值

### 2. 添加位置平滑處理
- 使用平滑因子 0.7 來減少手部位置的抖動
- 結合當前位置和歷史位置進行平滑計算

### 3. 增強調試信息
- 顯示檢測到的關節點數量
- 顯示平均置信度
- 顯示實時調試信息

## 手部識別不準確的可能原因

### 1. 環境因素
- **光線不足**：確保在光線充足的環境中使用
- **背景複雜**：避免複雜或移動的背景
- **手部遮擋**：確保手部完全在相機視野內

### 2. 手部姿勢
- **手部角度**：保持手部正面朝向相機
- **手部距離**：保持適當距離（建議 30-60cm）
- **手部大小**：手部不要太小或太大

### 3. 設備因素
- **相機品質**：不同設備的相機品質可能影響識別
- **處理性能**：設備性能可能影響識別速度

## 調試步驟

### 1. 使用測試視圖
1. 進入「手部識別測試」
2. 觀察以下指標：
   - 檢測置信度（應 > 0.5）
   - 檢測到的關節點數量（應 > 15）
   - 調試信息

### 2. 檢查手部姿勢
1. 確保手部完全可見
2. 保持手部正面朝向相機
3. 避免手指彎曲過度

### 3. 調整環境
1. 增加環境光線
2. 使用純色背景
3. 避免手部陰影

## 進一步優化建議

### 1. 動態參數調整
- 根據環境光線自動調整置信度閾值
- 根據手部大小調整檢測範圍

### 2. 多幀融合
- 結合多幀檢測結果提高準確性
- 使用時間窗口平滑處理

### 3. 手部追蹤
- 添加手部追蹤功能
- 預測手部移動軌跡

## 使用技巧

### 1. 最佳使用姿勢
- 手部距離相機 40-50cm
- 手部正面朝向相機
- 保持手部穩定

### 2. 手勢控制技巧
- 手掌移動時保持手部穩定
- 手勢變化時動作要明確
- 避免快速連續手勢

### 3. 故障排除
- 如果檢測不穩定，嘗試重新啟動識別
- 檢查相機權限是否正確
- 確保設備有足夠的處理能力

## 技術參數

### 當前設定
- 最小置信度閾值：0.5
- 平滑因子：0.7
- 最大手部數量：1
- 處理頻率：10fps

### 可調整參數
- `minConfidenceThreshold`：置信度閾值
- `smoothingFactor`：平滑因子
- `maxPalmHistorySize`：位置歷史記錄大小

## 最新更新 (2024-12-19)

### 主要變更
1. **移除舊的手勢檢測**
   - 刪除了握拳檢測功能
   - 刪除了食指與拇指觸碰檢測
   - 刪除了食指與中指觸碰檢測

2. **新增手掌旋轉手勢檢測**
   - 使用手掌的 Z 軸旋轉角度來控制方塊旋轉
   - 旋轉角度閾值：±30度
   - 手掌向左旋轉(<-30°)：方塊逆時針旋轉
   - 手掌向右旋轉(>30°)：方塊順時針旋轉
   - 手掌保持水平(-30°~30°)：無旋轉動作

3. **技術實現**
   - 使用手腕和 MCP 關節點計算手掌方向向量
   - 通過 `atan2` 函數計算旋轉角度
   - 添加旋轉冷卻時間(0.3秒)防止過於頻繁的旋轉
   - 保持原有的防彈跳機制

4. **UI 更新**
   - 更新測試視圖顯示手掌 Z 軸旋轉角度
   - 添加旋轉區域指示器
   - 更新教學視圖的手勢說明
   - 移除舊的手勢說明卡片

### 手勢控制總結

#### 移動控制
- **左側區域(1-3)**：方塊向左移動
- **中間區域(4-7)**：方塊不移動
- **右側區域(8-10)**：方塊向右移動

#### 旋轉控制
- **手掌向左旋轉(<-30°)**：方塊逆時針旋轉
- **手掌向右旋轉(>30°)**：方塊順時針旋轉
- **手掌保持水平(-30°~30°)**：無旋轉動作

### 參數設置
- 置信度閾值：0.5
- 旋轉角度閾值：30度
- 旋轉冷卻時間：0.3秒
- 手勢切換冷卻時間：0.5秒
- 最小置信度閾值：3

### 調試功能
- 實時顯示手掌 Z 軸旋轉角度
- 顯示旋轉區域指示器
- 保持原有的調試信息顯示

## 歷史優化記錄

### 2024-12-18 優化
1. **降低置信度閾值**
   - 從 0.7 降低到 0.5，提高手部檢測靈敏度

2. **添加手掌位置平滑**
   - 使用歷史記錄平滑手掌 X 軸位置
   - 減少位置跳動，提高控制穩定性

3. **增強調試信息**
   - 顯示檢測置信度
   - 顯示關節點數量
   - 實時更新調試狀態

4. **移除紅色圓點**
   - 簡化視覺化，只保留綠色骨架線條
   - 提高視覺清晰度

### 2024-12-17 優化
1. **X軸控制邏輯改進**
   - 將手掌位置分為三個區域：左(1-3)、中(4-7)、右(8-10)
   - 左移區域：方塊向左移動
   - 中間區域：方塊不移動
   - 右移區域：方塊向右移動

2. **視覺化改進**
   - 移除紅色圓點，只保留綠色骨架線條
   - 添加區域指示器顯示當前控制狀態

### 2024-12-16 優化
1. **消除相機重影問題**
   - 重新設計手部識別整合方式
   - 將手部識別嵌入 ARView 內部
   - 移除半透明相機視圖覆蓋

2. **創建 HandRecognitionService**
   - 統一管理 Vision 手部姿態檢測
   - 整合 ARSessionDelegate 進行實時幀處理
   - 提供手勢識別和遊戲動作映射

3. **手勢識別功能**
   - 手掌移動控制左右移動
   - 食指與拇指觸碰控制快速下降
   - 食指與中指觸碰控制順時針旋轉
   - 握拳控制逆時針旋轉

4. **視覺化功能**
   - 綠色骨架線條顯示手部關節連接
   - 紅色圓點顯示關節位置
   - 可開關的覆蓋層顯示

## 技術架構

### 核心組件
1. **HandRecognitionService**
   - 負責 Vision 手部姿態檢測
   - 整合 ARSessionDelegate
   - 提供遊戲動作映射

2. **GestureDetector**
   - 手勢識別邏輯
   - 防彈跳機制
   - 參數調整功能

3. **HandGestureGameView**
   - 整合 AR 遊戲和手部識別
   - 提供遊戲 UI 覆蓋層
   - 處理手勢到遊戲動作的轉換

### 數據流
```
ARFrame → HandRecognitionService → GestureDetector → GameAction → GameViewModel
```

### 性能優化
- 使用專用處理隊列避免阻塞主線程
- 實現防彈跳機制減少誤觸
- 添加冷卻時間防止過於頻繁的操作
- 使用歷史記錄平滑位置數據

## 使用說明

### 遊戲控制
1. **移動控制**：手掌左右移動控制方塊左右移動
2. **旋轉控制**：手掌旋轉控制方塊旋轉方向

### 調試功能
1. **測試視圖**：提供詳細的手部檢測信息
2. **教學視圖**：說明各種手勢的使用方法
3. **調試信息**：實時顯示檢測狀態和參數

### 參數調整
- 可通過代碼調整各種閾值和冷卻時間
- 支持運行時動態調整參數
- 提供詳細的調試信息幫助優化

## 未來改進方向
1. **手勢識別精度**：進一步提高手勢識別的準確性
2. **響應速度**：優化檢測和響應的延遲
3. **用戶體驗**：改進手勢的直觀性和易用性
4. **自適應參數**：根據用戶使用習慣自動調整參數 